pipeline {
    agent any

    environment {
        // –æ–±—Ä–∞–∑
        DOCKER_IMAGE = 'technobladedocker/fastapi-todo:v1' 
        // ID —Å–µ–∫—Ä–µ—Ç–∞ –≤ Jenkins
        DOCKER_CREDS = 'docker-hub-creds'
        // –ò–º—è –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç–∞ –≤ Kubernetes 
        K8S_DEPLOYMENT_NAME = 'fastapi-web'
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: DOCKER_CREDS, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        // –õ–æ–≥–∏–Ω
                        sh "echo $PASS | docker login -u $USER --password-stdin"
                        // –°–±–æ—Ä–∫–∞
                        sh "docker build -t $DOCKER_IMAGE ."
                        // –ü—É—à –≤ Hub
                        sh "docker push $DOCKER_IMAGE"
                    }
                }
            }
        }

        stage('Deploy to K8s') {
            steps {
                script {
                    echo "üöÄ Applying Kubernetes Manifests..."
                    
                    sh "kubectl apply -f k8s/"

                    echo "üîÑ Restarting Pods to pick up new image..."
                    
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫, —á—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å —Å–≤–µ–∂–∏–π –æ–±—Ä–∞–∑ v1
                    sh "kubectl rollout restart deployment/$K8S_DEPLOYMENT_NAME"
                    
                
                }
            }
        }
    }
    
    post {
        always {
            sh 'docker logout'
            // –£–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑, —á—Ç–æ–±—ã –Ω–µ –∑–∞–±–∏–≤–∞—Ç—å –º–µ—Å—Ç–æ –≤ Jenkins
            sh "docker rmi $DOCKER_IMAGE || true"
        }
    }
}